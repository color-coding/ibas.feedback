/*!
 * CanvasTools v1.0.0 
 * (github)https://github.com/S-mohan/canvasTools
 * (url) https://smohan.net/lab/canvastools
 * (c) smohan <https://smohan.net>
 * license MIT
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CanvasTools=e():t.CanvasTools=e()}(this,function(){return function(t){function e(a){if(n[a])return n[a].exports;var o=n[a]={i:a,l:!1,exports:{}};return t[a].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,a){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:a})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=4)}([function(t,e,n){"use strict";window.Element&&!Element.prototype.closest&&(Element.prototype.closest=function(t){var e,n=(this.document||this.ownerDocument).querySelectorAll(t),a=this;do{for(e=n.length;--e>=0&&n.item(e)!==a;);}while(e<0&&(a=a.parentElement));return a})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a={rect:{panel:"stroke",name:"矩形工具"},ellipse:{panel:"stroke",name:"椭圆工具"},brush:{panel:"stroke",name:"画笔工具"},arrow:{panel:"stroke",name:"箭头工具"},mosaic:{panel:"mosaic",name:"马赛克工具"},font:{panel:"font",name:"文字工具"},rubber:{name:"橡皮擦"},undo:{name:"撤销操作"},save:{name:"保存"}},o=["#000000","#808080","#800000","#f7883a","#308430","#385ad3","#800080","#009999","#ffffff","#c0c0c0","#fb3838","#ffff00","#99cc00","#3894e4","#f31bf3","#16dcdc"],i=[12,14,16,18,20,22],s=[2,4,6],r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[];for(var n in a)if(function(e){return t&&!!~t.indexOf(e)}(n)){var o=a[n];e.push('<div class="canvas-tools-btn js-btn" data-panel="'+(o.panel||"")+'" data-value="'+n+'" data-action="" title="'+o.name+'">\n\t\t\t<a class="btn-toggle"><i class="canvas-tools-icon__'+n+'"></i></a>\n\t\t\t</div>')}return e.join("")},l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"#fb3838",e="";e+='<div class="colors">',e+='<span class="color-selected"><i class="js-color-selected" style="background:'+t+'"></i></span>',e+='<div class="color-list">';for(var n=[],a=[],i=0;i<16;i++){var s='<li class="js-color" style="background:'+o[i]+'" data-value="'+o[i]+'"></li>';i<8?n.push(s):a.push(s)}return e+="<ul>"+n.join("")+"</ul>",e+="<ul>"+a.join("")+"</ul>",e+="</div>",e+="</div>"},c=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2,e='<div class="strokes">',n=0,a=s.length;n<a;n++){var o=s[n],i=["stroke","js-stroke-width"];o===t&&i.push("active"),e+='<a class="'+i.join(" ")+'" data-value="'+o+'"><i style="width:'+(o+1)+"px;height:"+(o+1)+'px;"></i></a>'}return e+="</div>"},u=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,e='<select class="font-select js-font-size">',n=0,a=i.length;n<a;n++){var o=i[n];e+='<option value="'+o+'" '+(o===t?"selected":"")+">"+o+"</option>"}return e+="</select>"},f=function(){return'<label class="ambiguite-range"><span>模糊度</span><input type="range" min="0" step="0.01" max="1" value="'+(arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5)+'" class="js-mosaic-ambiguity"></label>'};e.default={getButtons:r,getColorPanel:l,getStrokePanel:c,getFontPanel:u,getAmbiguity:f},t.exports=e.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=Array.prototype,i={id:/^#([\w-]+)$/,className:/^\.([\w-]+)$/,tagName:/^[\w-]+$/},s=function(t){return"[object Object]"===Object.prototype.toString.call(t)},r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"*",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;if("string"==typeof t){t=t.trim();var n=[];return i.id.test(t)?(n=document.getElementById(RegExp.$1),n=n?[n]:[]):n=i.className.test(t)?e.getElementsByClassName(RegExp.$1):i.tagName.test(t)?e.getElementsByTagName(t):e.querySelectorAll(t),o.slice.call(n)}return[]},l=function(t,e){if("object"===(void 0===t?"undefined":a(t))&&"function"==typeof e)if(Array.isArray(t))for(var n=0,o=t.length;n<o&&!1!==e.call(t[n],n,t[n]);n++);else if("length"in t&&"number"==typeof t.length)for(var i in t)if(!1===e.call(t[i],i,t[i]))break},c=function(t,e,n,a){var i=void 0,s=void 0;if("function"==typeof n)s=n;else{if("string"!=typeof n||"function"!=typeof a)return;i=n}i&&(s=function(e){for(var n=r(i,t),s=!1,l=0,c=n.length;l<c;l++){var u=n[l];if(u===e.target||u.contains(e.target)){s=u;break}}s&&a.apply(s,o.slice.call(arguments))}),t.addEventListener(e,s,!1)},u=function(t,e,n){return t.removeEventListener(e,n,!1)},f=function(t){return t.ownerDocument.defaultView.getComputedStyle(t,null)},d=function t(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=1,a=arguments.length;n<a;n++){var o=arguments[n];if(o&&Object.keys(o).length)for(var i in o)o.hasOwnProperty(i)&&(s(o[i])?e[i]=t(e[i],o[i]):e[i]=o[i])}return e},h=function(t,e,n,a){Array.isArray(t)||(t=[t]),l(t,function(t,o){return c(o,e,n,a)})},p=function(t,e,n){Array.isArray(t)||(t=[t]),l(t,function(t,a){return u(a,e,n)})},g=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"add",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";Array.isArray(t)||(t=[t]),l(t,function(t,a){return a.classList[e](n)})};e.default={$:r,each:l,bind:c,extend:d,unbind:u,getComputedStyles:f,classList:g,$on:h,$off:p},t.exports=e.default},function(t,e){},function(t,e,n){"use strict";function a(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(){var t=this,e=this.canvas,n=this.context,a=this.$el,o=this.state,i=this.config,c=this.rect,g=this._handles,v=this.history,y=m.default.$(".js-btn",a),b=m.default.$(".js-panel__font",a)[0],w=m.default.$(".js-panel__stroke",a)[0],k=m.default.$(".js-panel__mosaic",a)[0],T=m.default.$(".js-color-selected",a),$=m.default.$(".js-color",a),M=m.default.$(".js-stroke-width",a),j=m.default.$(".js-font-size",a),_=m.default.$(".js-mosaic-ambiguity",a);g.btnEmit=function(e){var a=this;e.stopPropagation(),"font"===o.drawType&&f.call(t,e);var i=this.getAttribute("data-panel"),s=this.getAttribute("data-value");if(m.default.each(y,function(t,e){e!==a&&m.default.classList(e,"remove","active")}),~x.indexOf(s)&&(o.drawType=s),i){m.default.classList(this,"toggle","active");var r=/active/.test(this.className),l=r?"block":"none";"stroke"===i?(b.style.display="none",k.style.display="none",w.style.display=l):"font"===i?(b.style.display=l,w.style.display="none",k.style.display="none"):"mosaic"===i&&(k.style.display=l,b.style.display="none",w.style.display="none")}if("save"===s)return void L.call(t);"undo"===s&&v.length>1&&(v.pop(),n.putImageData(v[v.length-1],0,0,0,0,c.width,c.height)),h.call(t)},g.toggleColor=function(t){var e=this.getAttribute("data-value");o.strokeColor=e,m.default.each(T,function(t,n){return n.style.background=e})},g.toggleStrokeWidth=function(t){o.strokeWidth=Number(this.getAttribute("data-value")),m.default.each(M,function(t,e){var n=Number(e.getAttribute("data-value")),a=n===o.strokeWidth?"add":"remove";m.default.classList(e,a,"active")})},g.toggleFontSize=function(t){o.fontSize=Number(this.value)};var E=void 0,C=null,S=0,P=0;g.onMouseDown=function(e){if(-1!=e.currentTarget.className.indexOf("tools-draggable")&&"canvas-tools"==e.target.className)C=e.currentTarget,S=C.offsetLeft-e.clientX,P=C.offsetTop-e.clientY;else{if(!1==!!~x.indexOf(o.drawType)||"font"===o.drawType||"canvas-tools-icon__undo"==e.target.className)return;switch(E=H(e,c),o.lastImageData=n.getImageData(0,0,c.width,c.height),n.lineCap="round",n.lineJoin="round",n.shadowBlur=0,n.strokeStyle=o.strokeColor,n.fillStyle=o.strokeColor,n.lineWidth=o.strokeWidth,o.drawType){case"rect":s.call(t,e,E);break;case"ellipse":r.call(t,e,E);break;case"mosaic":d.call(t,e);break;case"arrow":l.call(t,e,E);break;case"brush":default:u.call(t,e,E)}}m.default.$on(document,"mousemove",g.onMouseMove),m.default.$on(document,"mouseup",g.onMouseUp)},g.onMouseMove=function(e){if(C)i.container.style.marginLeft="0px",i.container.style.bottom="auto",i.container.style.left=S+e.clientX+"px",i.container.style.top=P+e.clientY+"px";else{if(!1==!!~x.indexOf(o.drawType)||"font"===o.drawType)return;switch(o.drawType){case"rect":s.call(t,e,E);break;case"ellipse":r.call(t,e,E);break;case"mosaic":d.call(t,e);break;case"arrow":l.call(t,e,E);break;case"brush":default:u.call(t,e,null)}}},g.onMouseUp=function(e){m.default.$off(document,"mousemove",g.onMouseMove),m.default.$off(document,"mouseup",g.onMouseUp),~x.indexOf(o.drawType)&&"font"!==o.drawType&&p.call(t),C=null,S=0,P=0},g.insertTextHelper=function(e){if(e.stopPropagation(),"font"===o.drawType){if(o.isEntry)return void f.call(t,e);N(e,o,c),o.isEntry=!0}},g.removeTextHelper=function(e){"font"!==o.drawType?D():e.target.closest("#canvas-tools-input")||f.call(t,e)},g.resize=function(n){var a=e.getBoundingClientRect();c.width=e.width,c.height=e.height,c.offsetWidth=e.offsetWidth,c.offsetHeight=e.offsetHeight,c.top=a.top,c.left=a.left,"font"===o.drawType&&o.isEntry&&f.call(t,n)},g.toggleAmbiguity=function(t){o.ambiguity=this.value,console.log(o)},m.default.$on(y,"click",g.btnEmit),m.default.$on($,"click",g.toggleColor),m.default.$on(M,"click",g.toggleStrokeWidth),m.default.$on(j,"change",g.toggleFontSize),m.default.$on(_,"change",g.toggleAmbiguity),m.default.$on(e,"mousedown",g.onMouseDown),m.default.$on(e,"click",g.insertTextHelper),m.default.$on(document,"click",g.removeTextHelper),window.addEventListener("resize",g.resize),m.default.$on(i.container,"mousedown",g.onMouseDown)}function s(t,e){var n=this.context,a=this.rect,o=this.state,i=H(t,a),s=i.x-e.x,r=i.y-e.y;n.clearRect(0,0,a.width,a.height),n.putImageData(o.lastImageData,0,0,0,0,a.width,a.height),n.save(),n.beginPath(),n.strokeRect(e.x,e.y,s,r),n.restore(),n.closePath()}function r(t,e){var n=this.context,a=this.rect,o=this.state,i=H(t,a),s=(i.x-e.x)/2*1,r=(i.y-e.y)/2*1,l=e.x/s+1,c=e.y/r+1;n.clearRect(0,0,a.width,a.height),n.putImageData(o.lastImageData,0,0,0,0,a.width,a.height),n.save(),n.beginPath(),n.scale(s,r),n.arc(l,c,1,0,2*Math.PI),n.restore(),n.closePath(),n.stroke()}function l(t,e){var n=this.context,a=this.rect,o=this.state,i=H(t,a),s=(i.x-e.x)/2*1,r=(i.y-e.y)/2*1;e.x,e.y;n.clearRect(0,0,a.width,a.height),n.putImageData(o.lastImageData,0,0,0,0,a.width,a.height),n.save(),n.beginPath();var l=c.call(this,e,i);n.moveTo(l[0],l[1]),n.lineTo(l[2],l[3]),n.lineTo(l[4],l[5]),n.lineTo(l[6],l[7]),n.lineTo(l[8],l[9]),n.lineTo(l[10],l[11]),n.restore(),n.closePath(),n.fill()}function c(t,e){var n=this.state,a=[],o=10*n.strokeWidth,i=25,s=e.x-t.x,r=e.y-t.y,l=Math.sqrt(Math.pow(s,2)+Math.pow(r,2));l<250?(o/=2,i/=2):l<500&&(o=o*l/500,i=i*l/500),a[0]=t.x,a[1]=t.y,a[6]=e.x,a[7]=e.y;var c=Math.atan2(e.y-t.y,e.x-t.x)/Math.PI*180;a[8]=e.x-o*Math.cos(Math.PI/180*(c+i)),a[9]=e.y-o*Math.sin(Math.PI/180*(c+i)),a[4]=e.x-o*Math.cos(Math.PI/180*(c-i)),a[5]=e.y-o*Math.sin(Math.PI/180*(c-i));var u={};return u.x=(a[4]+a[8])/2,u.y=(a[5]+a[9])/2,a[2]=(a[4]+u.x)/2,a[3]=(a[5]+u.y)/2,a[10]=(a[8]+u.x)/2,a[11]=(a[9]+u.y)/2,a}function u(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this.context,a=this.rect;if(e)n.beginPath(),n.moveTo(e.x,e.y);else{var o=H(t,a);n.lineTo(o.x,o.y),n.stroke()}}function f(t){var e=document.getElementById($);if(!e)return void(this.state.isEntry=!1);var n=e.textContent.trim(),a=n.length;if(!n||!a)return this.state.isEntry=!1,void D();var o=m.default.getComputedStyles(e),i=this.state.fontSize||M,s=2*T,r=this.context,l=(parseFloat(o.left)-this.rect.left)*E+s-2,c=(parseFloat(o.top)-this.rect.top)*C+i,u=0,f=0;r.beginPath(),r.save(),r.fillStyle=this.state.strokeColor,r.font=this.state.fontSize+"px "+j;for(var d=0;d<a;d++){var h=n[d];u+=r.measureText(h).width,u>this.rect.width-l&&(r.fillText(n.substring(f,d),l,c),c+=i,u=0,f=d),d==a-1&&r.fillText(n.substring(f,d+1),l,c)}r.restore(),r.closePath(),this.state.isEntry=!1,D(),p.call(this)}function d(t){for(var e=this.context,n=this.state,a=this.rect,o=H(t,a),i=3*n.strokeWidth,s=e.getImageData(o.x,o.y,i,i).data,r=0,l=0,c=0,u=0;u<i;u++)for(var f=0;f<i;f++)r+=s[4*(i*u+f)],l+=s[4*(i*u+f)+1],c+=s[4*(i*u+f)+2];r=Math.round(r/(i*i)),l=Math.round(l/(i*i)),c=Math.round(c/(i*i));var d="rgba("+r+", "+l+", "+c+", "+n.ambiguity+")";e.beginPath(),e.save(),e.fillStyle=d,e.fillRect(o.x,o.y,i,i),e.restore()}function h(){var t=this.canvas,e=void 0;switch(this.state.drawType){case"brush":e="brush";break;case"font":e="font";break;case"mosaic":e="mosaic";break;case"rect":case"ellipse":e="crosshair";break;default:e="default"}e&&(t.className=t.className.replace(/canvas-cursor__(\w+)/,"").trim()+" canvas-cursor__"+e)}function p(){this.history.push(this.context.getImageData(0,0,this.rect.width,this.rect.height))}Object.defineProperty(e,"__esModule",{value:!0});var g=function(){function t(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}}();n(3),n(0);var v=n(2),m=a(v),y=n(1),b=a(y),x=["rect","ellipse","brush","arrow","mosaic","font","rubber"],w="#fb3838",k=2,T=2,$="canvas-tools_text_helper",M=12,j='"Helvetica Neue",Helvetica,Arial,"Hiragino Sans GB","Hiragino Sans GB W3","WenQuanYi Micro Hei",sans-serif',_=.7,E=2,C=2,S=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:w,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__stroke",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=b.default.getStrokePanel(t)+b.default.getColorPanel(e),n},P=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:M,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__font",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=b.default.getFontPanel(t)+b.default.getColorPanel(e),n},A=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:w,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_,n=document.createElement("div");return n.className="canvas-tools__panel js-panel__mosaic",n.style.cssText+="white-space: nowrap!important;",n.innerHTML=b.default.getStrokePanel(t)+b.default.getAmbiguity(e),n},I=function(t){var e=document.getElementById($);return e||(e=document.createElement("div"),e.setAttribute("contenteditable","plaintext-only"),e.setAttribute("spellcheck","false"),e.setAttribute("id",$),e.className=$,t?t.appendChild(e):document.body.appendChild(e)),e.innerHTML="",e},N=function(t,e,n){var a=I(),o=e.fontSize||M,i=2*T+2,s=H(t,n),r=t.pageX,l=t.pageY,c=Math.floor(n.width-s.x)-i,u=Math.floor(n.height-s.y)-i;c<=o&&(r-=o+i-c,c=o),u<=o&&(l-=o+i-u,u=o),c>=n.width&&(c=n.width-s.x),u>=n.height&&(u=n.height-s.y);var f={"font-size":o+"px","line-height":o+"px","min-width":o+"px","min-height":o+"px","max-width":c+"px","max-height":u+"px","z-index":1990,"font-family":j,display:"block",position:"fixed",top:l+"px",left:r+"px",color:e.strokeColor,padding:T+"px",overflow:"hidden"},d="";for(var h in f)d+=h+":"+f[h]+";";return a.style.cssText=d,a.focus(),a},D=function(){var t=document.getElementById($);t&&(t.innerHTML="",t.style.cssText="display: none")},H=function(t,e){var n=t.pageX-e.left,a=t.pageY-e.top;return n<=0&&(n=0),n>=e.width&&(n=e.width),a<=0&&(a=0),a>=e.height&&(a=e.height),n*=E,a*=C,{x:n,y:a}},O={container:document.body,buttons:["rect","ellipse","brush","arrow","font","mosaic","undo","save"]},z=document.createElementNS("http://www.w3.org/1999/xhtml","a"),B="download"in z,L=function(){var t="canvas_"+Date.now()+".png",e=this.canvas;if(B){var n=e.toDataURL("png");n=n.replace("image/png","image/octet-stream"),setTimeout(function(){z.href=n,z.download=t,z.dispatchEvent(new MouseEvent("click"))})}else"undefined"!=typeof navigator&&"function"==typeof e.msToBlob&&navigator.msSaveBlob?navigator.msSaveBlob(e.msToBlob(),t):console.log("您的浏览器不支持该操作")},W=function(){function t(e,n){if(o(this,t),!e||"function"!=typeof e.getContext)throw new Error("invalid canvas object");this.canvas=e,this.context=e.getContext("2d"),this.config=m.default.extend({},O,n||{}),this.history=[],this.state=Object.create(null),this.rect=Object.create(null),this._handles=Object.create(null),this.state.strokeWidth=k,this.state.fontSize=M,this.state.strokeColor=w,this.state.ambiguity=_,this.state.drawType="brush",this.state.isEntry=!1,this.rect.width=e.width,this.rect.height=e.height,this.rect.offsetWidth=e.offsetWidth,this.rect.offsetHeight=e.offsetHeight;var a=e.getBoundingClientRect();this.rect.top=a.top,this.rect.left=a.left,this.state.lastImageData=this.context.getImageData(0,0,this.rect.width,this.rect.height),p.call(this),h.call(this),this.render()}return g(t,[{key:"render",value:function(){var t=this.config,e=this.state,n=document.createElement("div");n.className="canvas-tools",n.innerHTML=b.default.getButtons(t.buttons),t.container.appendChild(n),this.$el=n,this.$el.appendChild(S(e.strokeWidth,e.strokeColor)),this.$el.appendChild(P(e.fontSize,e.strokeColor)),this.$el.appendChild(A(e.strokeWidth,e.ambiguity)),i.call(this),I(this.config.container)}},{key:"refresh",value:function(){}},{key:"destory",value:function(){var t=this.canvas,e=this.$el,n=this._handles,a=m.default.$(".js-btn",e),o=m.default.$(".js-color",e),i=m.default.$(".js-stroke-width",e),s=m.default.$(".js-font-size",e),r=m.default.$(".js-mosaic-ambiguity",e),l=document.getElementById($);m.default.$off(a,"click",n.btnEmit),m.default.$off(o,"click",n.toggleColor),m.default.$off(i,"click",n.toggleStrokeWidth),m.default.$off(s,"change",n.toggleFontSize),m.default.$off(r,"change",n.toggleAmbiguity),m.default.$off(t,"mousedown",n.onMouseDown),m.default.$off(t,"click",n.insertTextHelper),m.default.$off(document,"click",n.removeTextHelper),window.removeEventListener("resize",n.resize),l&&l.parentNoed.removeChild(l),this.canvas=null,this.context=null,this.history.length=0,this.config.container.removeChild(this.$el),m.default.$off(this.config.container,"mousedown",n.onMouseDown)}}]),t}();e.default=W,t.exports=e.default}])});